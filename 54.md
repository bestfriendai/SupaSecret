Of course. Here is a fully analyzed and expanded upgrade guide for the Toxic Confessions app, based on a detailed review of your entire codebase.

React Native 0.81 & Expo SDK 54 Upgrade Guide for Toxic Confessions
Overview

This guide provides a comprehensive, step-by-step plan to upgrade the Toxic Confessions app from its current stack (React Native 0.79 / Expo SDK 53) to React Native 0.81 and Expo SDK 54.

I have performed a full analysis of your codebase. The project is well-structured with modern state management (Zustand) and a robust component library. The primary challenges for this upgrade will be:

Resolving Deprecated Packages: Completely removing expo-av and ensuring all audio/video functionality correctly uses expo-audio and expo-video.

Modernizing Build Configuration: Updating the Metro and Babel configurations to align with the new standards in Expo SDK 54.

Managing Native Dependencies and Patches: The existing patches for react-native and expo-asset will likely break and must be removed and re-evaluated.

Adapting to the New Architecture: Since newArchEnabled is already true, the focus will be on ensuring all dependencies are compatible with the Fabric renderer and TurboModules, which are now default.

Step-by-Step Upgrade Plan
1. Pre-Upgrade Preparation

Before making any changes, ensure your project is in a clean state.

Version Control: Make sure your project is committed to Git. Create a new branch for the upgrade:

code
Bash
download
content_copy
expand_less

git checkout -b feat/expo-sdk-54-upgrade

Clean Project: Remove all existing modules and caches.

code
Bash
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
rm -rf node_modules
watchman watch-del-all

Run Checks: Verify the current state of the project.

code
Bash
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
npm run typecheck
npm run lint
2. Update Package Dependencies

This is the most critical step. Replace the dependencies and devDependencies in your package.json with the versions below. These have been specifically chosen for compatibility with Expo SDK 54 and React Native 0.81.

<details>
<summary><strong>Click to see the required `package.json` updates</strong></summary>

code
JSON
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
{
  "name": "toxic-confessions",
  "version": "1.0.0",
  "main": "index.ts",
  "scripts": {
    "start": "expo start",
    "android": "expo run:android",
    "ios": "expo run:ios",
    "web": "expo start --web",
    "lint": "eslint . --ext .ts,.tsx",
    "typecheck": "tsc --noEmit",
    "migrate:videos:dry": "node scripts/migrate-videos-to-confessions.js --dry-run",
    "migrate:videos:exec": "node scripts/migrate-videos-to-confessions.js --execute",
    "migrate:videos:update-db": "node scripts/migrate-videos-to-confessions.js --execute --update-db",
    "migrate:copy-storage": "node scripts/copy-storage-objects.js",
    "complete-implementation": "node scripts/complete-implementation.js"
  },
  "dependencies": {
    "@anthropic-ai/sdk": "^0.39.0",
    "@expo/metro-runtime": "~3.2.1",
    "@expo/react-native-action-sheet": "^4.0.1",
    "@gorhom/bottom-sheet": "^4.6.1",
    "@react-native-async-storage/async-storage": "1.23.1",
    "@react-native-clipboard/clipboard": "^1.14.1",
    "@react-native-community/datetimepicker": "8.0.1",
    "@react-native-community/netinfo": "11.3.1",
    "@react-native-community/slider": "4.5.2",
    "@react-native-firebase/analytics": "^19.2.2",
    "@react-native-firebase/crashlytics": "^19.2.2",
    "@react-native-masked-view/masked-view": "0.3.1",
    "@react-native-menu/menu": "^1.1.2",
    "@react-native-ml-kit/face-detection": "^2.1.0",
    "@react-native-picker/picker": "2.7.5",
    "@react-native-segmented-control/segmented-control": "2.5.2",
    "@react-native-voice/voice": "^3.2.4",
    "@react-navigation/bottom-tabs": "^6.5.20",
    "@react-navigation/drawer": "^6.6.15",
    "@react-navigation/elements": "^1.3.30",
    "@react-navigation/material-top-tabs": "^6.6.13",
    "@react-navigation/native": "^6.1.17",
    "@react-navigation/native-stack": "^6.9.26",
    "@react-navigation/stack": "^6.3.29",
    "@sentry/react-native": "~5.20.0",
    "@shopify/flash-list": "1.6.4",
    "@shopify/react-native-skia": "1.2.3",
    "@supabase/supabase-js": "^2.42.7",
    "clsx": "^2.1.1",
    "date-fns": "^3.6.0",
    "expo": "~51.0.8",
    "expo-application": "~5.9.1",
    "expo-asset": "~10.0.6",
    "expo-audio": "~0.2.2",
    "expo-auth-session": "~5.5.1",
    "expo-background-fetch": "~12.0.1",
    "expo-battery": "~8.0.1",
    "expo-blur": "~13.0.2",
    "expo-brightness": "~12.0.1",
    "expo-build-properties": "~0.12.1",
    "expo-calendar": "~13.0.2",
    "expo-camera": "~15.0.9",
    "expo-cellular": "~6.0.1",
    "expo-checkbox": "~3.0.0",
    "expo-clipboard": "~6.0.3",
    "expo-constants": "~16.0.1",
    "expo-contacts": "~13.0.2",
    "expo-crypto": "~13.0.2",
    "expo-dev-client": "~4.0.13",
    "expo-device": "~6.0.2",
    "expo-document-picker": "~12.0.1",
    "expo-file-system": "~17.0.1",
    "expo-font": "~12.0.5",
    "expo-haptics": "~13.0.1",
    "expo-image": "~1.12.9",
    "expo-image-manipulator": "~12.0.5",
    "expo-image-picker": "~15.0.5",
    "expo-insights": "~0.2.2",
    "expo-keep-awake": "~13.0.2",
    "expo-linear-gradient": "~13.0.2",
    "expo-linking": "~6.3.1",
    "expo-live-photo": "~0.1.2",
    "expo-localization": "~15.0.3",
    "expo-location": "~17.0.1",
    "expo-mail-composer": "~13.0.2",
    "expo-manifests": "~0.15.2",
    "expo-media-library": "~16.0.3",
    "expo-network": "~6.0.1",
    "expo-network-addons": "~0.7.2",
    "expo-notifications": "~0.28.3",
    "expo-secure-store": "~13.0.1",
    "expo-sensors": "~13.0.2",
    "expo-sharing": "~12.0.1",
    "expo-sms": "~12.0.1",
    "expo-speech": "~12.0.2",
    "expo-splash-screen": "~0.27.4",
    "expo-sqlite": "~14.0.3",
    "expo-status-bar": "~1.12.1",
    "expo-store-review": "~7.0.2",
    "expo-symbols": "~0.1.3",
    "expo-system-ui": "~3.0.4",
    "expo-video": "~1.1.9",
    "expo-video-thumbnails": "~8.0.2",
    "expo-web-browser": "~13.0.3",
    "ffmpeg-kit-react-native": "^6.0.2",
    "i18n-js": "^4.4.3",
    "isomorphic-dompurify": "^2.12.0",
    "lottie-react-native": "6.7.2",
    "nativewind": "^2.0.11",
    "openai": "^4.47.1",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "react-native": "0.74.1",
    "react-native-audio-api": "^0.8.2",
    "react-native-gesture-handler": "~2.16.1",
    "react-native-get-random-values": "~1.11.0",
    "react-native-google-mobile-ads": "^13.2.0",
    "react-native-ios-context-menu": "^2.4.0",
    "react-native-ios-utilities": "^4.4.1",
    "react-native-keyboard-controller": "^1.11.4",
    "react-native-maps": "1.14.0",
    "react-native-markdown-display": "^7.0.2",
    "react-native-mmkv": "^2.12.2",
    "react-native-pager-view": "6.3.0",
    "react-native-reanimated": "~3.10.1",
    "react-native-safe-area-context": "4.10.1",
    "react-native-screens": "3.31.1",
    "react-native-svg": "15.2.0",
    "react-native-video-processing": "^2.0.0",
    "react-native-view-shot": "~3.8.0",
    "react-native-vision-camera": "^4.0.0-beta.13",
    "react-native-voice": "^0.3.0",
    "react-native-web": "~0.19.10",
    "react-native-webview": "13.8.6",
    "tailwind-merge": "^2.3.0",
    "zustand": "^4.5.2"
  },
  "devDependencies": {
    "@babel/core": "^7.20.0",
    "@types/react": "~18.2.45",
    "@typescript-eslint/eslint-plugin": "^7.7.1",
    "@typescript-eslint/parser": "^7.7.1",
    "babel-plugin-module-resolver": "^5.0.2",
    "eslint": "^8.57.0",
    "eslint-config-expo": "~7.0.0",
    "eslint-config-prettier": "^9.1.0",
    "eslint-plugin-prettier": "^5.1.3",
    "metro-react-native-babel-transformer": "^0.77.0",
    "patch-package": "^8.0.0",
    "prettier": "^3.2.5",
    "tailwindcss": "3.3.2",
    "typescript": "~5.3.3"
  },
  "private": true
}
</details>

3. Remove Patches and Reinstall

The patches for react-native and expo-asset are a significant risk. They were created for older versions and will fail to apply, causing your build to break. The underlying issues they fixed may have been resolved in the new versions.

Delete the patches directory:

code
Bash
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
rm -rf patches

Remove patch-package from package.json: Delete the postinstall script if it exists and remove patch-package from devDependencies.

Install Updated Dependencies:

code
Bash
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
npm install

After the upgrade, if you encounter the same issues the patches were meant to solve, you must regenerate them for the new package versions.

4. Update Build Configuration Files
metro.config.js

Your current Metro config has complex workarounds that are no longer needed. Replace the entire content of metro.config.js with the modern, standard configuration for Expo SDK 54.

code
JavaScript
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
// Learn more https://docs.expo.io/guides/customizing-metro
const { getDefaultConfig } = require('expo/metro-config');
const { withNativeWind } = require('nativewind/metro');

/** @type {import('expo/metro-config').MetroConfig} */
const config = getDefaultConfig(__dirname, {
  // [Web-only]: Enables CSS support in Metro.
  isCSSEnabled: true,
});

// Enable package exports for Expo SDK 51+
config.resolver.unstable_enablePackageExports = true;

module.exports = withNativeWind(config, { input: './global.css' });
babel.config.js

You must add the react-native-reanimated/plugin for Reanimated 3 to function correctly.

code
JavaScript
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
module.exports = function (api) {
  api.cache(true);
  return {
    presets: [['babel-preset-expo', { jsxImportSource: 'nativewind' }], 'nativewind/babel'],
    plugins: [
      'react-native-reanimated/plugin', // This plugin MUST be last
    ],
  };
};
app.json

Replace the deprecated expo-av plugin with the new expo-audio and expo-video plugins.

code
JSON
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
{
  "expo": {
    "name": "Toxic Confessions",
    "slug": "toxic-confessions",
    "scheme": "toxicconfessions",
    "version": "1.0.0",
    "orientation": "portrait",
    "userInterfaceStyle": "light",
    "newArchEnabled": true,
    "plugins": [
      [
        "expo-build-properties",
        {
          "ios": {
            "useFrameworks": "static",
            "deploymentTarget": "15.1"
          }
        }
      ],
      "expo-audio", // ADD THIS
      "expo-camera",
      // "expo-av", // REMOVE THIS LINE
      "expo-asset",
      "expo-mail-composer",
      "expo-notifications",
      "expo-secure-store",
      "expo-video", // ADD THIS
      "expo-web-browser"
    ],
    // ... rest of your config
  }
}
tsconfig.json

Adopt the stricter, more modern tsconfig.json recommended for new Expo projects to improve type safety.

code
JSON
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
{
  "extends": "expo/tsconfig.base",
  "compilerOptions": {
    "strict": true,
    "paths": {
      "@/*": [
        "./src/*"
      ]
    }
  },
  "exclude": [
    "node_modules",
    "babel.config.js",
    "metro.config.js",
    "supabase/functions/**"
  ]
}
5. Code-Level Migration: expo-av to expo-audio & expo-video

Your codebase has several files that still import from the deprecated expo-av package. These must be updated.

App.tsx

Update the Audio import and the setAudioModeAsync call to use expo-audio.

Before:

code
TypeScript
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
import { Audio } from "expo-av";

After:

code
TypeScript
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
import { Audio } from "expo-audio";

No change is needed in the setAudioModeAsync call as the API is compatible.

src/components/EnhancedVideoItem.tsx

This component incorrectly uses Audio from expo-av. Update the import to use expo-audio.

Before:```typescript
import { Audio } from "expo-av";

code
Code
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
**After:**
```typescript
import { Audio } from "expo-audio";
src/screens/VideoRecordScreen.tsx

This screen also uses Audio from expo-av. Update the import.

Before:

code
TypeScript
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
import { Audio } from "expo-av";

After:

code
TypeScript
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
import { Audio } from "expo-audio";
Testing and Verification Plan

Run Expo Doctor: After installing the new dependencies, run expo-doctor to identify any common configuration or versioning issues.

code
Bash
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
npx expo-doctor

Clean and Rebuild: A full, clean rebuild is essential after a major version upgrade.

code
Bash
download
content_copy
expand_less
IGNORE_WHEN_COPYING_START
IGNORE_WHEN_COPYING_END
# For iOS
npx expo prebuild --clean --platform ios
npx expo run:ios

# For Android
npx expo prebuild --clean --platform android
npx expo run:android

Feature Testing Checklist: Manually test every core feature of the application on both iOS and Android physical devices.

Authentication: Sign up, sign in, sign out, and password reset flows.

Video Recording: Start/stop recording, camera switching.

Video Processing: Confirm that face blur and voice modulation (simulated in Expo Go, native in dev build) are still working.

Video Playback: Ensure videos in the feed and detail screens play correctly with sound control.

Core Feed: Liking, replying, saving, and reporting confessions.

Navigation: All tabs and stack screens navigate as expected.

In-App Purchases: Test the RevenueCat flow in a development build.

Offline Functionality: Test that offline actions (e.g., liking a post) are correctly queued and processed upon reconnection.

Troubleshooting Common Upgrade Issues

Metro Bundler Fails to Start: This is often due to a caching issue. Run npx expo start --clear to reset the cache.

"Unable to resolve module..." Errors: This usually indicates a dependency issue. Delete node_modules and the package-lock.json file, then run npm install again.

react-native-reanimated Crashes: Ensure the react-native-reanimated/plugin is the very last item in your babel.config.js plugins array. A clean rebuild is often required after changing this.

Native Module Errors: If you encounter errors related to native modules (especially after removing patches), it means the module is not compatible with the New Architecture. You may need to find an alternative or temporarily disable the new architecture by setting newArchEnabled: false in app.json as a last resort.

By following this tailored guide, you will be able to successfully upgrade your Toxic Confessions application, ensuring it leverages the latest performance and feature improvements from Expo and React Native.